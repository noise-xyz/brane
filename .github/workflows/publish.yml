name: Publish to Maven Central

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (stage only, do not publish)'
        required: false
        default: 'false'
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Validate version
        run: |
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "Project version: $VERSION"
          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            echo "ERROR: Cannot publish SNAPSHOT version to Maven Central"
            exit 1
          fi

      - name: Build and verify
        run: ./gradlew build -x test

      - name: Stage release artifacts
        run: ./gradlew stageRelease

      - name: List staged artifacts
        run: |
          echo "=== Staged Artifacts ==="
          find . -path "*/staging-deploy/*" -name "*.pom" | head -20

      - name: Publish to Maven Central
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.GPG_PUBLIC_KEY }}
          JRELEASER_GPG_SECRET_KEY: ${{ secrets.GPG_SECRET_KEY }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          JRELEASER_MAVENCENTRAL_CENTRAL_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          JRELEASER_MAVENCENTRAL_CENTRAL_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        run: ./gradlew jreleaserDeploy

      - name: Dry run notice
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: echo "Dry run complete - artifacts staged but not published"

  publish-snapshots:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Check if snapshot
        id: version-check
        run: |
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            echo "is_snapshot=true" >> $GITHUB_OUTPUT
          else
            echo "is_snapshot=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish snapshots
        if: steps.version-check.outputs.is_snapshot == 'true'
        env:
          JRELEASER_MAVENCENTRAL_CENTRAL_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          JRELEASER_MAVENCENTRAL_CENTRAL_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        run: ./gradlew publishSnapshot
